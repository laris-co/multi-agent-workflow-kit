# shellcheck shell=bash

codex_dir="$PWD/.codex"
if [[ -z "${CODEX_HOME:-}" && -d "$codex_dir" ]]; then
  export CODEX_HOME="$codex_dir"
fi

scripts_dir="$PWD/.agents/scripts"
codex_dir="$PWD/.codex"

if [[ -z "${CODEX_HOME:-}" && -d "$codex_dir" ]]; then
  export CODEX_HOME="$codex_dir"
fi

if [[ -d "$scripts_dir" ]]; then
  if command -v PATH_add >/dev/null 2>&1; then
    PATH_add "$scripts_dir"
  else
    if [[ :$PATH: != *":$scripts_dir:"* ]]; then
      export PATH="$scripts_dir:$PATH"
    fi
  fi
  alias maw-start="start-agents.sh"
  alias maw-setup="setup.sh"
  alias maw-agents="agents.sh"
  alias maw-kill="kill-all.sh"
  alias maw-send="send-commands.sh"
  alias maw-remove="remove.sh"
  alias maw-uninstall="uninstall.sh"

  maw() {
    if [[ $# -eq 0 ]]; then
      cat <<'USAGE'
Usage: maw <command> [args]

Commands:
  install | setup    Run setup.sh to provision or refresh agent worktrees
  start              Run start-agents.sh to launch the tmux session
  agents             Run agents.sh to manage worktrees manually
  kill               Run kill-all.sh to terminate tmux sessions by prefix
  send               Run send-commands.sh to broadcast commands to panes
  remove             Run remove.sh to delete agent worktrees
  uninstall          Run uninstall.sh to remove toolkit assets
USAGE
      return 1
    fi

    local subcommand=$1
    shift || true

    case "$subcommand" in
      install|setup)
        command "$scripts_dir/setup.sh" "$@"
        ;;
      start)
        command "$scripts_dir/start-agents.sh" "$@"
        ;;
      agents)
        command "$scripts_dir/agents.sh" "$@"
        ;;
      kill)
        command "$scripts_dir/kill-all.sh" "$@"
        ;;
      send)
        command "$scripts_dir/send-commands.sh" "$@"
        ;;
      remove)
        command "$scripts_dir/remove.sh" "$@"
        ;;
      uninstall)
        command "$scripts_dir/uninstall.sh" "$@"
        ;;
      help|-h|--help)
        cat <<'USAGE'
Usage: maw <command> [args]

Commands:
  install | setup    Run setup.sh to provision or refresh agent worktrees
  start              Run start-agents.sh to launch the tmux session
  agents             Run agents.sh to manage worktrees manually
  kill               Run kill-all.sh to terminate tmux sessions by prefix
  send               Run send-commands.sh to broadcast commands to panes
  remove             Run remove.sh to delete agent worktrees
  uninstall          Run uninstall.sh to remove toolkit assets
USAGE
        ;;
      *)
        echo "Unknown maw command: $subcommand" >&2
        return 1
        ;;
    esac
  }
fi
